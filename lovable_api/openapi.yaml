openapi: 3.0.3
info:
  title: Lovable Agentic API (POC)
  version: 0.1.0
servers:
  - url: http://localhost:8000
security:
  - bearerAuth: []
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
  schemas:
    CampaignRun:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }
        status: { type: string, enum: [draft, running, paused, complete, failed, aborted] }
        criteria:
          type: object
          properties:
            industry_preferences_text: { type: string }
            exclusions_text: { type: string }
            locations_text: { type: string }
            size_text: { type: string }
        progress:
          type: object
          properties:
            seed_rows_total: { type: integer }
            leads_created: { type: integer }
            leads_enriched_places: { type: integer }
            leads_enriched_website: { type: integer }
            leads_scored: { type: integer }
            tasks_created: { type: integer }
            tasks_completed: { type: integer }
            errors: { type: integer }
    Event:
      type: object
      properties:
        id: { type: string }
        campaign_run_id: { type: string }
        time: { type: string, format: date-time }
        type: { type: string }
        lead_id: { type: string, nullable: true }
        message: { type: string }
        payload: { type: object }
    LeadRow:
      type: object
      properties:
        id: { type: string }
        owner_name: { type: string }
        owner_email: { type: string }
        business_name: { type: string }
        city: { type: string }
        state: { type: string }
        employees: { type: integer }
        score_total: { type: integer }
        tier: { type: string }
        vertical_category: { type: string, nullable: true }
        profile_confidence: { type: number, nullable: true }
        top_reasons:
          type: array
          items: { type: string }
        next_task:
          type: object
          nullable: true
          properties:
            task_id: { type: string }
            type: { type: string }
            due_at_est: { type: string, format: date-time }
    LeadDetail:
      type: object
      properties:
        id: { type: string }
        campaign_run_id: { type: string }
        seed: { type: object }
        business: { type: object }
        owner: { type: object }
        evidence: { type: object }
        extractions: { type: object }
        score:
          type: object
          properties:
            total: { type: integer, description: 'Back-compat: equals final_total' }
            rules_total: { type: integer }
            ai_total: { type: integer }
            final_total: { type: integer }
            tier: { type: string }
            ai_used: { type: boolean }
            reasoning_bullets:
              type: array
              items: { type: string }
            reasoning_citations:
              type: array
              items:
                type: object
                properties:
                  field: { type: string }
                  value: { }
        campaign_plan: { type: object }
        task_ids:
          type: array
          items: { type: string }
        business_profile:
          type: object
          nullable: true
        message_drafts:
          type: array
          items: { $ref: '#/components/schemas/MessageDraft' }
    Task:
      type: object
      properties:
        id: { type: string }
        campaign_run_id: { type: string }
        lead_id: { type: string }
        type: { type: string }
        channel: { type: string }
        status: { type: string }
        due_at_est: { type: string, format: date-time }
        window_start_est: { type: string, format: date-time, nullable: true }
        window_end_est: { type: string, format: date-time, nullable: true }
        instructions: { type: string }
        template_id: { type: string, nullable: true }
        tactic_id: { type: string, nullable: true }
        experiment_id: { type: string, nullable: true }
        completion:
          type: object
          properties:
            completed_at: { type: string, format: date-time, nullable: true }
            outcome_code: { type: string, nullable: true }
            outcome_notes: { type: string, nullable: true }

    MessageDraft:
      type: object
      properties:
        id: { type: string }
        campaign_run_id: { type: string }
        lead_id: { type: string }
        channel: { type: string, enum: [email, linkedin, phone] }
        template_id: { type: string }
        subject: { type: string, nullable: true }
        body: { type: string }
        personalization_facts:
          type: array
          items: { type: string }
        safety_checks_passed: { type: boolean }
        created_at: { type: string, format: date-time }

    OutreachAttempt:
      type: object
      properties:
        id: { type: string }
        campaign_run_id: { type: string }
        lead_id: { type: string }
        channel: { type: string, enum: [email, phone, linkedin, other] }
        template_id: { type: string, nullable: true }
        tactic_id: { type: string, nullable: true }
        experiment_id: { type: string, nullable: true }
        executed_at: { type: string, format: date-time }

    Tactic:
      type: object
      properties:
        id: { type: string }
        campaign_run_id: { type: string }
        name: { type: string }
        description: { type: string }
        channels:
          type: array
          items: { type: string }
        target_segment: { type: object }
        hypothesis: { type: string }
        pattern: { type: object }
        created_by: { type: string, enum: [ai, human] }
        status: { type: string, enum: [proposed, active, archived] }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }

    Experiment:
      type: object
      properties:
        id: { type: string }
        campaign_run_id: { type: string }
        tactic_id: { type: string }
        allocation_pct: { type: integer }
        started_at: { type: string, format: date-time }
        ended_at: { type: string, format: date-time, nullable: true }
        status: { type: string, enum: [active, ended] }
        outcome_code:
          type: string
          enum: [sent, delivered, replied, positive, negative, meeting_booked, bounced, unsubscribed]
        outcome_notes: { type: string, nullable: true }
        created_at: { type: string, format: date-time }
paths:
  /v1/health:
    get:
      summary: Basic health check
      description: Unauthenticated service liveness probe.
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  service: { type: string }
                  time: { type: string, format: date-time }

  /v1/health/openai:
    get:
      summary: OpenAI integration health
      parameters:
        - in: query
          name: probe
          required: false
          schema: { type: boolean, default: false }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  configured: { type: boolean }
                  model: { type: string }
                  ok: { type: boolean, nullable: true }
                  status_code: { type: integer, nullable: true }
                  latency_ms: { type: integer, nullable: true }
                  error: { nullable: true }
  /v1/campaign-runs:
    get:
      summary: List campaign runs
      parameters:
        - in: query
          name: limit
          required: false
          schema: { type: integer, default: 50 }
        - in: query
          name: cursor
          required: false
          schema: { type: string }
        - in: query
          name: status
          required: false
          schema: { type: string, description: 'Comma-separated statuses' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/CampaignRun' }
                  nextCursor: { type: string, nullable: true }
    post:
      summary: Create campaign run
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
                criteria: { $ref: '#/components/schemas/CampaignRun/properties/criteria' }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/CampaignRun' }
  /v1/campaign-runs/{campaign_run_id}:
    get:
      summary: Get campaign run
      parameters:
        - in: path
          name: campaign_run_id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/CampaignRun' }

  /v1/campaign-runs/{campaign_run_id}/abort:
    post:
      summary: Abort campaign run
      description: Marks a stuck/running campaign run as aborted.
      parameters:
        - in: path
          name: campaign_run_id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/CampaignRun' }
        '409':
          description: Conflict
          content:
            application/json:
              schema:
                type: object
                properties:
                  detail: { type: string }

  /v1/campaign-runs/{campaign_run_id}/import/seed-csv:
    post:
      summary: Import seed CSV
      parameters:
        - in: path
          name: campaign_run_id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  imported: { type: integer }
  /v1/campaign-runs/{campaign_run_id}/run:
    post:
      summary: Start pipeline
      parameters:
        - in: path
          name: campaign_run_id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/CampaignRun' }
  /v1/campaign-runs/{campaign_run_id}/events:
    get:
      summary: Poll events
      parameters:
        - in: path
          name: campaign_run_id
          required: true
          schema: { type: string }
        - in: query
          name: cursor
          required: false
          schema: { type: string }
        - in: query
          name: limit
          required: false
          schema: { type: integer, default: 200 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: array
                    items: { $ref: '#/components/schemas/Event' }
                  nextCursor: { type: string, nullable: true }
  /v1/campaign-runs/{campaign_run_id}/leads:
    get:
      summary: List leads
      parameters:
        - in: path
          name: campaign_run_id
          required: true
          schema: { type: string }
        - in: query
          name: tier
          required: false
          schema: { type: string, description: 'Comma-separated list' }
        - in: query
          name: sort
          required: false
          schema: { type: string, enum: [score_desc, score_asc], default: score_desc }
        - in: query
          name: limit
          required: false
          schema: { type: integer, default: 50 }
        - in: query
          name: cursor
          required: false
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  leads:
                    type: array
                    items: { $ref: '#/components/schemas/LeadRow' }
                  nextCursor: { type: string, nullable: true }
  /v1/leads/{leadId}:
    get:
      summary: Lead detail
      parameters:
        - in: path
          name: leadId
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/LeadDetail' }

  /v1/message-drafts:
    get:
      summary: List message drafts
      parameters:
        - in: query
          name: campaign_run_id
          required: true
          schema: { type: string }
        - in: query
          name: lead_id
          required: false
          schema: { type: string }
        - in: query
          name: channel
          required: false
          schema: { type: string, enum: [email, linkedin, phone] }
        - in: query
          name: limit
          required: false
          schema: { type: integer, default: 200 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/MessageDraft' }

  /v1/campaign-runs/{campaign_run_id}/generate-message-drafts:
    post:
      summary: Generate message drafts (manual)
      description: Generate 1 email MessageDraft per lead if missing.
      parameters:
        - in: path
          name: campaign_run_id
          required: true
          schema: { type: string }
        - in: query
          name: tier
          required: false
          schema: { type: string, default: 'A,B' }
        - in: query
          name: limit
          required: false
          schema: { type: integer, default: 25 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  campaign_run_id: { type: string }
                  created: { type: integer }
                  skipped: { type: integer }
                  considered: { type: integer }
  /v1/tactics:
    get:
      summary: List tactics
      parameters:
        - in: query
          name: campaign_run_id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/Tactic' }

  /v1/campaign-runs/{campaign_run_id}/tactics/generate:
    post:
      summary: Generate tactic proposals (AI)
      parameters:
        - in: path
          name: campaign_run_id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/Tactic' }

  /v1/tactics/{tactic_id}/activate:
    post:
      summary: Activate tactic (human)
      parameters:
        - in: path
          name: tactic_id
          required: true
          schema: { type: string }
        - in: query
          name: allocation_pct
          required: false
          schema: { type: integer, default: 10, minimum: 1, maximum: 50 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  experiment_id: { type: string }
                  tactic_id: { type: string }
                  allocation_pct: { type: integer }

  /v1/experiments:
    get:
      summary: List experiments
      parameters:
        - in: query
          name: campaign_run_id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items: { $ref: '#/components/schemas/Experiment' }

  /v1/experiments/{experiment_id}/end:
    post:
      summary: End experiment
      parameters:
        - in: path
          name: experiment_id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  experiment_id: { type: string }
                  status: { type: string }

  /v1/tasks:
    get:
      summary: List tasks
      parameters:
        - in: query
          name: campaign_run_id
          required: false
          schema: { type: string }
        - in: query
          name: status
          required: false
          schema: { type: string, description: 'Comma-separated statuses' }
        - in: query
          name: due_before
          required: false
          schema: { type: string, format: date-time }
        - in: query
          name: limit
          required: false
          schema: { type: integer, default: 200 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  tasks:
                    type: array
                    items: { $ref: '#/components/schemas/Task' }
  /v1/tasks/{taskId}:
    patch:
      summary: Update task
      parameters:
        - in: path
          name: taskId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Task' }
  /v1/outreach-attempts:
    post:
      summary: Log outreach attempt (back-compat)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                campaign_run_id: { type: string }
                lead_id: { type: string }
                channel: { type: string, enum: [email, phone, linkedin, other] }
                template_id: { type: string, nullable: true }
                executed_at: { type: string, format: date-time }
                outcome_code:
                  type: string
                  enum: [sent, delivered, replied, positive, negative, meeting_booked, bounced, unsubscribed]
                outcome_notes: { type: string, nullable: true }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/OutreachAttempt' }
    get:
      summary: List outreach attempts
      parameters:
        - in: query
          name: campaign_run_id
          required: false
          schema: { type: string }
        - in: query
          name: lead_id
          required: false
          schema: { type: string }
        - in: query
          name: limit
          required: false
          schema: { type: integer, default: 200 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  outreach_attempts:
                    type: array
                    items: { $ref: '#/components/schemas/OutreachAttempt' }

  /v1/attempts:
    post:
      summary: Log execution attempt
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                campaign_run_id: { type: string }
                lead_id: { type: string }
                channel: { type: string, enum: [email, phone, linkedin, other] }
                template_id: { type: string, nullable: true }
                executed_at: { type: string, format: date-time }
                outcome_code:
                  type: string
                  enum: [sent, delivered, replied, positive, negative, meeting_booked, bounced, unsubscribed]
                outcome_notes: { type: string, nullable: true }
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/OutreachAttempt' }

  /v1/metrics/overview:
    get:
      summary: Overview metrics
      parameters:
        - in: query
          name: campaign_run_id
          required: false
          schema: { type: string }
        - in: query
          name: from
          required: false
          schema: { type: string, format: date-time }
        - in: query
          name: to
          required: false
          schema: { type: string, format: date-time }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  leads_total: { type: integer }
                  tiers: { type: object }
                  tasks_total: { type: integer }
                  tasks_done: { type: integer }
                  task_completion_rate: { type: number }
                  attempts_total: { type: integer }
                  attempts_by_channel: { type: object }
                  replies_total: { type: integer }
                  positive_replies_total: { type: integer }
                  meetings_total: { type: integer }
                  bounces_total: { type: integer }
                  unsubscribes_total: { type: integer }
                  bounce_rate: { type: number }
                  reply_rate: { type: number }
                  meeting_rate: { type: number }
                  attempts_last_7d: { type: integer }
                  replies_last_7d: { type: integer }
                  meetings_last_7d: { type: integer }
                  reply_rate_last_7d: { type: number }
                  meeting_rate_last_7d: { type: number }
                  last_7d_cutoff_utc: { type: string }
